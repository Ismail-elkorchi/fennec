openapi: 3.1.0
info:
  title: Fennec Control Plane API
  version: 0.1.0
  description: |
    Contract-first baseline for the Fennec control plane.
    This spec is the source of truth for UI, CLI, agent, and integrations.
  contact:
    name: Fennec Maintainers
    url: https://github.com/Ismail-elkorchi/fennec
servers:
  - url: /
tags:
  - name: meta
    description: Metadata and health endpoints.
  - name: agent
    description: Agent-facing job endpoints.
paths:
  /healthz:
    get:
      summary: Health check
      description: Returns service health for load balancers and probes.
      operationId: getHealthz
      tags:
        - meta
      security: []
      responses:
        '200':
          description: Service is healthy.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthStatus'
        '500':
          description: Service error.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
  /version:
    get:
      summary: Build and version metadata
      description: Returns build and version information for the running service.
      operationId: getVersion
      tags:
        - meta
      security: []
      responses:
        '200':
          description: Version details.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VersionInfo'
        '500':
          description: Service error.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
  /readyz:
    get:
      summary: Readiness check
      description: Returns readiness based on database connectivity.
      operationId: getReadyz
      tags:
        - meta
      security: []
      responses:
        '200':
          description: Service is ready.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyStatus'
        '503':
          description: Database is unavailable.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
  /agent/v1/jobs/claim:
    post:
      summary: Claim next job
      description: Claims the next available job for an authenticated agent.
      operationId: claimAgentJob
      tags:
        - agent
      security:
        - AgentToken: []
      responses:
        '200':
          description: Job claimed.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '204':
          description: No jobs available.
        '401':
          description: Unauthorized.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Database unavailable.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
  /agent/v1/jobs/{id}/complete:
    post:
      summary: Complete a job
      description: |
        Marks a running job as succeeded or failed for the authenticated agent.
        This endpoint is retry-safe: if the same agent repeats a completion request with the
        same terminal `status`, `result`, and `error`, the server returns the existing terminal
        job without mutation.
      operationId: completeAgentJob
      tags:
        - agent
      security:
        - AgentToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobCompleteRequest'
      responses:
        '200':
          description: |
            Job completed, or an identical duplicate completion was replayed and returned idempotently.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '400':
          description: Invalid request.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '401':
          description: Unauthorized.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '409':
          description: |
            Job conflict. Returned when the job is not currently running for this agent, when a stale
            agent tries to complete a re-claimed job, or when the request conflicts with an existing
            terminal state.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Database unavailable.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
  /agent/v1/jobs/{id}/heartbeat:
    post:
      summary: Heartbeat a job lease
      description: |
        Extends the lease for a running job owned by the authenticated agent.
        Heartbeat is accepted only for the current lock holder while the job is in `running` state.
        Heartbeat after completion or from a stale agent is rejected.
      operationId: heartbeatAgentJob
      tags:
        - agent
      security:
        - AgentToken: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Job lease extended.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '401':
          description: Unauthorized.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '409':
          description: |
            Job conflict. Returned when the job is not running for this agent, including stale-owner
            requests and post-completion heartbeats.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
        '503':
          description: Database unavailable.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
  /openapi.yaml:
    get:
      summary: OpenAPI specification in YAML
      description: Returns the current OpenAPI document for this service.
      operationId: getOpenApiYaml
      tags:
        - meta
      security: []
      responses:
        '200':
          description: OpenAPI YAML document.
          content:
            application/yaml:
              schema:
                type: string
            text/yaml:
              schema:
                type: string
        '500':
          description: Spec unavailable.
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ProblemDetails'
components:
  securitySchemes:
    SessionCookie:
      type: apiKey
      in: cookie
      name: fennec_session
    ApiToken:
      type: http
      scheme: bearer
      bearerFormat: token
    AgentMTLS:
      type: mutualTLS
    AgentToken:
      type: http
      scheme: bearer
      bearerFormat: token
  schemas:
    HealthStatus:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - ok
    ReadyStatus:
      type: object
      required:
        - status
        - db
      properties:
        status:
          type: string
          enum:
            - ok
        db:
          type: string
          enum:
            - ok
    JobResponse:
      type: object
      required:
        - job
      properties:
        job:
          $ref: '#/components/schemas/Job'
    JobCompleteRequest:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum:
            - succeeded
            - failed
        result:
          type: object
          additionalProperties: true
        error:
          type: string
    Job:
      type: object
      required:
        - id
        - type
        - payload
        - status
        - created_at
        - scheduled_at
        - attempt
        - max_attempts
        - result
      properties:
        id:
          type: integer
        type:
          type: string
        payload:
          type: object
          additionalProperties: true
        status:
          type: string
        created_at:
          type: string
        scheduled_at:
          type: string
        locked_at:
          type: string
          nullable: true
        started_at:
          type: string
          nullable: true
        finished_at:
          type: string
          nullable: true
        heartbeat_at:
          type: string
          nullable: true
        lease_expires_at:
          type: string
          nullable: true
        attempt:
          type: integer
        max_attempts:
          type: integer
        locked_by_agent_id:
          type: integer
          nullable: true
        result:
          type: object
          additionalProperties: true
        last_error:
          type: string
          nullable: true
    VersionInfo:
      type: object
      required:
        - name
        - version
        - commit
        - build_time
      properties:
        name:
          type: string
        version:
          type: string
        commit:
          type: string
        build_time:
          type: string
    ProblemDetails:
      type: object
      required:
        - type
        - title
        - status
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
          minimum: 100
          maximum: 599
        detail:
          type: string
        instance:
          type: string
          format: uri
      additionalProperties: true
